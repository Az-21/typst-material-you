using System.Text;
using ThemePair = (string, string);

namespace M3Parser.Io;
internal static class Output
{
  private const string OutputFolder = "Output";
  internal static void WriteThemes(in List<(string, List<ThemePair>)> themes, in string version)
  {
    // Ensure output folder exists
    bool outputExists = Path.Exists(OutputFolder);
    if (!outputExists) { Directory.CreateDirectory(OutputFolder); }

    // Write
    Console.WriteLine("\nGenerating typst theme(s):");
    foreach (var theme in themes)
    {
      // Location
      string typstFilename = theme.Item1 + ".typ";
      string path = Path.Combine(OutputFolder, typstFilename);

      // Content
      string typstThemeVariable = GenerateTypstThemeVariable(theme, version);
      File.WriteAllText(path, typstThemeVariable);

      // Print status
      PrintGeneratedFilename(path);
    }

  }

  private static string GenerateTypstThemeVariable(in (string, List<ThemePair>) theme, in string version)
  {
    // Generate theme file contents
    StringBuilder sb = new();
    // Version info
    sb.AppendLine(@"// Autogenerated using https://github.com/Az-21/typst-material-you");
    sb.AppendLine($"// Version: {version}");
    sb.AppendLine();

    // Light values
    GenerateVariable(sb, theme.Item2, "light");
    sb.AppendLine();

    // Dark values
    GenerateVariable(sb, theme.Item2, "dark");

    return sb.ToString();
  }

  private static void GenerateVariable(StringBuilder sb, in List<ThemePair> themePairs, in string brightness)
  {
    sb.AppendLine($"#let m3{brightness} = (");
    foreach (ThemePair themePair in themePairs)
    {
      string name = themePair.Item1; // light-primary
      string hex = themePair.Item2;

      string redundantTerm = brightness + '-'; // light-
      string nameWithoutBrightness = name.Replace(redundantTerm, String.Empty); // primary

      if (name.StartsWith(brightness)) { sb.AppendLine($"""  {nameWithoutBrightness}: rgb("{hex}"),"""); }
    }
    sb.AppendLine(")");
  }

  private static void PrintGeneratedFilename(in string path) => Console.WriteLine($"  - {path} [ Done ]");
}
